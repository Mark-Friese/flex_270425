name: Test Flexibility Analysis

on:
  push:
    branches: [ main, develop ]
    paths:
      - "firm_capacity_analysis/**"
      - ".github/workflows/test-flexibility-analysis.yml"
  pull_request:
    branches: [ main, develop ]
    paths:
      - "firm_capacity_analysis/**"
      - ".github/workflows/test-flexibility-analysis.yml"

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch all history for proper versioning
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install testing dependencies from the platform-independent file
        if [ -f firm_capacity_analysis/requirements-test.txt ]; then 
          pip install -r firm_capacity_analysis/requirements-test.txt
        else
          # Fallback if file doesn't exist yet
          pip install pytest pandas numpy matplotlib pyyaml
        fi
        
        # Install only non-platform specific requirements
        if [ -f requirements.txt ]; then
          # Skip platform-specific packages (pywin32)
          pip install $(grep -v "pywin32" requirements.txt | grep -v "^#")
        fi
        
    - name: Create output directories
      run: |
        mkdir -p firm_capacity_analysis/output/Monktonhall
        mkdir -p firm_capacity_analysis/tests/output
        mkdir -p firm_capacity_analysis/tests/reference_data/Monktonhall
        
    - name: Check for reference data
      run: |
        if [ ! -d "firm_capacity_analysis/tests/reference_data" ] || [ -z "$(ls -A firm_capacity_analysis/tests/reference_data)" ] || [ ! -f "firm_capacity_analysis/tests/reference_data/Monktonhall/competitions.json" ]; then
          echo "ERROR: Reference data not found in repository. Tests cannot run."
          exit 1
        else
          echo "Using reference data from repository"
        fi
        
        # Create __init__.py files if they don't exist
        mkdir -p firm_capacity_analysis/tests/reference_data/Monktonhall
        [ -f firm_capacity_analysis/tests/__init__.py ] || echo '"""Test package for firm capacity analysis."""' > firm_capacity_analysis/tests/__init__.py
        [ -f firm_capacity_analysis/tests/reference_data/__init__.py ] || echo '"""Reference data package for tests."""' > firm_capacity_analysis/tests/reference_data/__init__.py
        [ -f firm_capacity_analysis/tests/reference_data/Monktonhall/__init__.py ] || echo '"""Reference data for Monktonhall substation."""' > firm_capacity_analysis/tests/reference_data/Monktonhall/__init__.py
        
        # Copy reference data to output directory for tests
        mkdir -p firm_capacity_analysis/output/Monktonhall
        cp firm_capacity_analysis/tests/reference_data/Monktonhall/competitions.json firm_capacity_analysis/output/Monktonhall/
        cp firm_capacity_analysis/tests/reference_data/Monktonhall/metadata.json firm_capacity_analysis/output/Monktonhall/
        cp firm_capacity_analysis/tests/reference_data/Monktonhall/firm_capacity_results.csv firm_capacity_analysis/output/Monktonhall/
        
        # Create pytest.ini for test discovery if it doesn't exist
        if [ ! -f firm_capacity_analysis/pytest.ini ]; then
          echo '[pytest]' > firm_capacity_analysis/pytest.ini
          echo 'python_files = test_*.py' >> firm_capacity_analysis/pytest.ini
          echo 'testpaths = tests' >> firm_capacity_analysis/pytest.ini
          echo 'python_classes = *Test' >> firm_capacity_analysis/pytest.ini
          echo 'python_functions = test_*' >> firm_capacity_analysis/pytest.ini
        fi
        
    - name: Run tests
      run: |
        cd firm_capacity_analysis
        # Debug information
        echo "===== Directory Structure ====="
        ls -la
        echo "===== Tests Directory Structure ====="
        ls -la tests/
        echo "===== Reference Data Structure ====="
        ls -la tests/reference_data/
        ls -la tests/reference_data/Monktonhall/
        echo "===== Python Path ====="
        python -c "import sys; print(sys.path)"
        echo "===== Test Collection ====="
        python -m pytest -v --collect-only tests/
        echo "===== Running Tests ====="
        python -m pytest -v tests/
        
        
    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      if: success() || failure()  # Upload artifacts even if tests fail
      with:
        name: test-artifacts
        path: |
          firm_capacity_analysis/tests/output/
          firm_capacity_analysis/output/*/service_window_mwh.csv
