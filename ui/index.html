<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flexibility Analysis System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Leaflet CSS for maps -->
    <link href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="css/styles.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <header class="bg-dark text-white py-2 px-4 d-flex justify-content-between align-items-center shadow">
            <div class="d-flex align-items-center">
                <img src="assets/logo.svg" alt="Flexibility Analysis System Logo" class="app-logo">
                <h1 class="h2 m-0 fw-bold">Flexibility Analysis System</h1>
            </div>
            <div class="d-flex align-items-center">
                <div id="configStatus" class="me-3">
                    <span class="badge bg-warning py-2 px-3">Config Not Loaded</span>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-light dropdown-toggle rounded-pill" type="button" id="settingsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-cog me-1"></i> Settings
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="settingsDropdown">
                        <li><a class="dropdown-item" href="#" id="loadConfigBtn"><i class="fas fa-file-import me-2"></i>Load Configuration</a></li>
                        <li><a class="dropdown-item" href="#" id="outputDirBtn"><i class="fas fa-folder-open me-2"></i>Set Output Directory</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="viewLogsBtn"><i class="fas fa-list-alt me-2"></i>View Logs</a></li>
                    </ul>
                </div>
            </div>
        </header>

        <div class="row mt-3">
            <!-- Sidebar -->
            <div class="col-md-3">
                <!-- Analysis Form -->
                <div class="card mb-3 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-bolt me-2"></i>Analysis Settings
                    </div>
                    <div class="card-body">
                        <form id="analysisForm">
                            <div class="mb-3">
                                <label for="substationSelect" class="form-label">Substation</label>
                                <select id="substationSelect" class="form-select" required disabled>
                                    <option value="">Select a substation...</option>
                                </select>
                                <div class="form-text">Select a substation to analyze</div>
                            </div>
                            
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="generateCompetitionsCheck" checked>
                                <label class="form-check-label" for="generateCompetitionsCheck">Generate Competitions</label>
                            </div>
                            
                            <div class="mb-3">
                                <label for="targetYearInput" class="form-label">Target Year (optional)</label>
                                <input type="number" class="form-control" id="targetYearInput" placeholder="e.g., 2025">
                                <div class="form-text">Year to use for competition dates</div>
                            </div>
                            
                            <button type="submit" id="runAnalysisBtn" class="btn btn-success w-100 py-2 fw-bold" disabled>
                                <i class="fas fa-play me-2"></i>Run Analysis
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Previous Results -->
                <div class="card mb-3 shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <i class="fas fa-history me-2"></i>Previous Results
                    </div>
                    <div class="card-body">
                        <div id="previousResultsList">
                            <p class="text-center text-muted">No results available</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9">
                <!-- Status Panel -->
                <div class="card mb-3 shadow-sm">
                    <div class="card-body p-2">
                        <div id="statusArea" class="alert alert-secondary mb-0">
                            Ready to start. Please load a configuration file.
                        </div>
                        <div class="progress mt-2 d-none" id="progressBar">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Results Tabs -->
                <div class="card shadow">
                    <div class="card-header bg-light">
                        <ul class="nav nav-tabs card-header-tabs" id="resultsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">
                                    <i class="fas fa-chart-line me-1"></i>Summary
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="plots-tab" data-bs-toggle="tab" data-bs-target="#plots" type="button" role="tab">
                                    <i class="fas fa-chart-area me-1"></i>Plots
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="competitions-tab" data-bs-toggle="tab" data-bs-target="#competitions" type="button" role="tab">
                                    <i class="fas fa-trophy me-1"></i>Competitions
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="map-tab" data-bs-toggle="tab" data-bs-target="#map" type="button" role="tab">
                                    <i class="fas fa-map-marked-alt me-1"></i>Map
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="docs-tab" data-bs-toggle="tab" data-bs-target="#docs" type="button" role="tab">
                                    <i class="fas fa-book me-1"></i>Documentation
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="resultsTabContent">
                            <!-- Summary Tab -->
                            <div class="tab-pane fade show active" id="summary" role="tabpanel">
                                <div id="summaryContent">
                                    <div class="alert alert-info" id="noResultsMessage">
                                        <i class="fas fa-info-circle me-2"></i>No analysis results to display. Please run an analysis first.
                                    </div>
                                    <div id="resultsArea" class="d-none">
                                        <h4 id="summaryTitle" class="mb-3">Results Summary</h4>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="card mb-3 bg-light">
                                                    <div class="card-body">
                                                        <h5 class="card-title">Firm Capacity</h5>
                                                        <div class="row">
                                                            <div class="col-6">
                                                                <div class="metric-card text-center p-3 border rounded mb-2">
                                                                    <h6>Standard E(C)</h6>
                                                                    <div class="h3" id="metricCPlain">-</div>
                                                                    <small>MW</small>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="metric-card text-center p-3 border rounded mb-2 border-primary bg-primary bg-opacity-10">
                                                                    <h6>Peak-based E(C)</h6>
                                                                    <div class="h3" id="metricCPeak">-</div>
                                                                    <small>MW</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card mb-3 bg-light">
                                                    <div class="card-body">
                                                        <h5 class="card-title">Demand Statistics</h5>
                                                        <div class="row">
                                                            <div class="col-6">
                                                                <div class="metric-card text-center p-3 border rounded mb-2">
                                                                    <h6>Mean Demand</h6>
                                                                    <div class="h3" id="metricMeanDemand">-</div>
                                                                    <small>MW</small>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="metric-card text-center p-3 border rounded mb-2">
                                                                    <h6>Max Demand</h6>
                                                                    <div class="h3" id="metricMaxDemand">-</div>
                                                                    <small>MW</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="card mb-3 bg-light">
                                                    <div class="card-body">
                                                        <h5 class="card-title">Energy</h5>
                                                        <div class="row">
                                                            <div class="col-6">
                                                                <div class="metric-card text-center p-3 border rounded mb-2">
                                                                    <h6>Total Energy</h6>
                                                                    <div class="h3" id="metricTotalEnergy">-</div>
                                                                    <small>MWh</small>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="metric-card text-center p-3 border rounded mb-2">
                                                                    <h6>Energy Above Capacity</h6>
                                                                    <div class="h3" id="metricEnergyAbove">-</div>
                                                                    <small>MWh</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card mb-3 bg-light">
                                                    <div class="card-body">
                                                        <h5 class="card-title">Competition Info</h5>
                                                        <div class="row">
                                                            <div class="col-6">
                                                                <div class="metric-card text-center p-3 border rounded mb-2">
                                                                    <h6>Target</h6>
                                                                    <div class="h3" id="metricTarget">-</div>
                                                                    <small>MWh</small>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="metric-card text-center p-3 border rounded mb-2">
                                                                    <h6>Competitions</h6>
                                                                    <div class="h3" id="metricCompetitions">-</div>
                                                                    <small>Count</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="table-responsive mt-3">
                                            <table class="table table-striped table-hover" id="summaryTable">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Metric</th>
                                                        <th>Value</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Plots Tab -->
                            <div class="tab-pane fade" id="plots" role="tabpanel">
                                <div id="plotsContainer" class="text-center">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>No plots available. Please run an analysis first.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Competitions Tab -->
                            <div class="tab-pane fade" id="competitions" role="tabpanel">
                                <div id="competitionsContainer">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>No competitions available. Please run an analysis with "Generate Competitions" enabled.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Map Tab -->
                            <div class="tab-pane fade" id="map" role="tabpanel">
                                <div class="d-flex justify-content-between mb-3">
                                    <div>
                                        <select id="mapStyleSelect" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                                            <option value="street">Street Map</option>
                                            <option value="satellite">Satellite</option>
                                            <option value="terrain">Terrain</option>
                                        </select>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="exportMapData()">
                                            <i class="fas fa-download me-1"></i>Export Data
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="showDataImportModal()">
                                            <i class="fas fa-upload me-1"></i>Import Data
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="autoGenerateMapData()">
                                            <i class="fas fa-magic me-1"></i>Auto-Generate
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="mapContainer" style="height: 500px">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>No map data available.
                                    </div>
                                </div>
                                
                                <div class="card mt-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Map Data Status</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="mapDataStatus">
                                            <div class="d-flex justify-content-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <script>
                                // Map style change handler
                                document.getElementById('mapStyleSelect').addEventListener('change', function() {
                                    if (!map) return;
                                    
                                    // Remove existing tile layers
                                    map.eachLayer(layer => {
                                        if (layer instanceof L.TileLayer) {
                                            map.removeLayer(layer);
                                        }
                                    });
                                    
                                    // Add new tile layer based on selection
                                    const style = this.value;
                                    
                                    if (style === 'satellite') {
                                        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                                            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                                        }).addTo(map);
                                    } else if (style === 'terrain') {
                                        L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                                            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
                                        }).addTo(map);
                                    } else {
                                        // Default to street map
                                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                                        }).addTo(map);
                                    }
                                });
                            </script>
                            
                            <!-- Documentation Tab -->
                            <div class="tab-pane fade" id="docs" role="tabpanel">
                                <div class="d-flex justify-content-between mb-3 align-items-center">
                                    <h5 class="mb-0">System Documentation</h5>
                                    <div>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" id="docHomeBtn">
                                                <i class="fas fa-home me-1"></i>Home
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" id="docBackBtn">
                                                <i class="fas fa-arrow-left me-1"></i>Back
                                            </button>
                                        </div>
                                        <select id="docSectionSelect" class="form-select form-select-sm ms-2" style="width: auto; display: inline-block;">
                                            <option value="index.html">Home</option>
                                            <option value="installation/index.html">Installation</option>
                                            <option value="usage/index.html">User Guide</option>
                                            <option value="technical/index.html">Technical Docs</option>
                                            <option value="development/index.html">Developer Guide</option>
                                            <option value="reference/glossary.html">Glossary</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="card shadow-sm mb-3">
                                    <div class="card-body p-0">
                                        <div id="docContainer" style="height: 600px; border: 1px solid #dee2e6; border-radius: 0.25rem;">
                                            <iframe id="docFrame" src="" style="width: 100%; height: 100%; border: none;" title="Documentation"></iframe>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    This is the built-in documentation for the Flexibility Analysis System. You can browse all topics offline from within the application.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="bg-dark text-white text-center py-3 mt-4">
            <div class="small">Flexibility Analysis System &copy; 2025</div>
        </footer>
    </div>
    
    <!-- Modal for Logs -->
    <div class="modal fade" id="logsModal" tabindex="-1" aria-labelledby="logsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logsModalLabel">Application Logs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre id="logsContent" class="bg-dark text-light p-3" style="max-height: 400px; overflow-y: auto;"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for Map Data Import -->
    <div class="modal fade" id="dataImportModal" tabindex="-1" aria-labelledby="dataImportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dataImportModalLabel">Import Map Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="importStatus" class="alert" style="display: none;"></div>
                    
                    <div class="mb-3">
                        <label for="mapDataFile" class="form-label">Select JSON File</label>
                        <input class="form-control" type="file" id="mapDataFile" accept=".json">
                        <div class="form-text">Please select a JSON file containing substation coordinates and demand group data.</div>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Required Format</h6>
                        <p class="mb-2">The JSON file should include:</p>
                        <ul>
                            <li><strong>substations</strong>: Array of substation objects with name, coordinates, and metadata</li>
                            <li><strong>demand_groups</strong>: Array of demand group objects with polygons and metadata</li>
                        </ul>
                        <details>
                            <summary>View Example Format</summary>
                            <pre class="mt-2" style="background-color: #f8f9fa; padding: 10px; font-size: 12px; max-height: 200px; overflow-y: auto;">
{
  "substations": [
    {
      "name": "monktonhall",
      "display_name": "Monkton Hall",
      "coordinates": {
        "lat": 55.1234,
        "lng": -1.5678
      },
      "metadata": {
        "voltage_level": "33/11kV"
      }
    }
  ],
  "demand_groups": [
    {
      "id": "northeast_group_1",
      "name": "Northeast Group 1",
      "polygon": {
        "points": [
          {"lat": 55.1, "lng": -1.5},
          {"lat": 55.2, "lng": -1.5},
          {"lat": 55.2, "lng": -1.6},
          {"lat": 55.1, "lng": -1.6},
          {"lat": 55.1, "lng": -1.5}
        ]
      }
    }
  ]
}</pre>
                        </details>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="handleMapDataImport()">Import</button>
                    <button type="button" class="btn btn-outline-primary" onclick="exportMapData()">
                        <i class="fas fa-download me-1"></i>Export Current Data
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script src="js/app.js"></script>
</body>
</html>
