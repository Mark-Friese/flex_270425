# Flexibility Analysis Testing Framework

This directory contains tests and utilities for the Flexibility Analysis system to ensure code changes do not create unintended consequences.

## Directory Structure

```
tests/
├── reference_data/      # Contains baseline outputs for comparison
│   └── Monktonhall/     # Reference data for each substation
├── output/              # Test artifacts and intermediate files
├── README.md            # This file
├── conftest.py          # Pytest fixtures
├── copy_reference_data.py       # Utility to create reference datasets
├── generate_service_window_mwh.py  # Utility to extract MWh data
├── test_competitions.py          # Tests for competition generation
├── test_firm_capacity.py         # Tests for firm capacity calculations
└── test_service_windows.py       # Tests for service window generation
```

## Setting Up the Testing Framework

### 1. Creating Reference Datasets

Reference datasets are the baseline outputs that we compare against to ensure consistency. To create reference datasets:

```bash
python tests/copy_reference_data.py --output-dir output --reference-dir tests/reference_data
```

This script copies the output files from a known-good run to the reference directory.

### 2. Generating Service Window MWh Data

To extract and save MWh data for each service window:

```bash
python tests/generate_service_window_mwh.py --substations Monktonhall
```

This creates a CSV file with MWh data for each service window, which is useful for testing energy consistency.

### 3. Running Tests

To run all tests:

```bash
cd firm_capacity_analysis
python -m pytest tests/
```

To run specific test files:

```bash
python -m pytest tests/test_firm_capacity.py
python -m pytest tests/test_competitions.py
python -m pytest tests/test_service_windows.py
```

To run with verbose output:

```bash
python -m pytest -v tests/
```

### 4. Data Review Process

For critical changes, run the data review script to generate comparison reports:

```bash
python tests/data_review.py --substations Monktonhall
```

This creates HTML and CSV reports in the `reports` directory, highlighting any significant changes between reference data and new outputs.

## CI/CD Integration

The testing framework is integrated with GitHub Actions. The workflow file is located at:

```
.github/workflows/test-flexibility-analysis.yml
```

The workflow runs automatically on push to main/develop branches or pull requests targeting these branches.

## Adding New Tests

When adding new functionality:

1. Add tests to the appropriate test file
2. Update reference data if necessary
3. Run the test suite to ensure everything passes

## Adding New Substations

To add a new substation to the testing framework:

1. Generate outputs for the new substation
2. Update the `substations` list in `conftest.py`
3. Create reference data for the new substation:
   ```bash
   python tests/copy_reference_data.py --output-dir output --reference-dir tests/reference_data
   ```
4. Run the tests to verify everything works as expected

## Troubleshooting

If tests are failing, check:

1. Reference data exists for all substations
2. The output directory contains the expected files
3. The code changes have not introduced unintended side effects

For detailed analysis, review the data comparison reports generated by `data_review.py`.